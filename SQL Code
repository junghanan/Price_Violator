DROP TABLE PRICE_MULTIPLIER_VIOLATOR; 
CREATE TABLE  PRICE_MULTIPLIER_VIOLATOR AS (

WITH MAIN AS (
       SELECT
        PRINT.DEAL_YEAR
        ,PRINT.REPORT_PROMO_WEEK_NUM 
        ,PRINT.DEAL_NUM  
        ,PRINT.PAGE_NUM 
        ,PRINT.SLOT_NUM 
        ,(PRINT.DEAL_NUM ||'-' ||PRINT.PAGE_NUM ||'-' ||PRINT.SLOT_NUM) DPS 
        ,PRINT.SLOT_SPACE_MTE_RATIO 
        ,PRINT.DIVISION_NM 
        ,PRINT.LOB_NM
        ,PRINT.CATEGORY_NM
        ,PRINT.FINELINE_NM 
        ,PRINT.CTR_PRODUCT_NUM
        ,PRINT.PRODUCT_ENGLISH_SHORT_DESC
        ,PRINT.SHOW_IND
        ,PRINT.REGULAR_RETAIL_PRICE_AMT
        ,PRINT.PROMO_RETAIL_PRICE_AMT
        ,PRINT.POS_FORECAST_FACTORED_QTY
        ,PRINT.POS_FORECAST_FACTORED_AMT
        ,MIN(PRINT.PROMO_RETAIL_PRICE_AMT) OVER (PARTITION BY PRINT.DEAL_YEAR,PRINT.DEAL_NUM,PRINT.PAGE_NUM,PRINT.SLOT_NUM) MIN_PROMO_PRICE
        ,MAX(PRINT.PROMO_RETAIL_PRICE_AMT) OVER (PARTITION BY PRINT.DEAL_YEAR,PRINT.DEAL_NUM,PRINT.PAGE_NUM,PRINT.SLOT_NUM) MAX_PROMO_PRICE
        ,CASE 
           WHEN MIN_PROMO_PRICE=0 THEN  ROUND(MAX_PROMO_PRICE/1,0) 
           ELSE ROUND(MAX_PROMO_PRICE/MIN_PROMO_PRICE,2) 
        END AS PRICE_MULTIPLIER
        ,CASE
           WHEN PRICE_MULTIPLIER>=5  THEN 'VIOLATOR' 
           ELSE 'PASS'
        END AS VIOLATOR
        FROM EDWPRDAWPRP.ADMIN_CTC.UV_PRINT_MEDIA_DIM PRINT
        LEFT JOIN EDWPRD.ADMIN_CTC.PRODUCT_CURRENT_DIM PROD ON PRINT.CTR_PRODUCT_NUM = PROD.PRODUCT_NUM 
        LEFT JOIN 
                (SELECT 
                 DISTINCT DEAL_NUM
                 ,DEAL_YEAR
                 ,DEAL_KIND_ENGLISH_NM
                 FROM EDWPRD.ADMIN_CTC.DEAL_CURRENT_DIM
                 WHERE DEAL_YEAR = CAST(EXTRACT(YEAR FROM CURRENT_DATE) AS VARCHAR(4))
                ) DEAL ON PRINT.DEAL_YEAR = DEAL.DEAL_YEAR AND PRINT.DEAL_NUM = DEAL.DEAL_NUM
        WHERE PRINT.SLOT_SPACE_MTE_RATIO<0.2 AND PRINT.LOB_NM NOT IN ('TIRES','FOOD & DRINKS') AND PRINT.CATEGORY_NM NOT IN ('BRAKES', 'BRAKE REPAIR','STEERING & SUSPENSION', 'PAINTS','HOUSEHOLD CLEANING SOLUTIONS', 'LAUNDRY, HAND & DISH CLEANING SOLUTIONS','PET ACCESSORIES','PET FOOD','HOUSEHOLD CONSUMABLES') 
        AND PRINT.DEAL_YEAR = CAST(EXTRACT(YEAR FROM CURRENT_DATE) AS VARCHAR(4)) 
        AND PROD.PRODUCT_TYPE_CD <> 'PPK' 
        AND PRINT.PAGE_NUM <>-1 
        AND DEAL.DEAL_KIND_ENGLISH_NM NOT IN ('ORDERING TOOL', 'IEP DEAL','GRAND OPENING') 
        AND PRINT.LOB_NM <> 'FOOD & DRINKS' AND PRINT.CATEGORY_NM NOT IN ('HOUSEHOLD CLEANING SOLUTIONS', 'LAUNDRY, HAND & DISH CLEANING SOLUTIONS','PET ACCESSORIES','PET FOOD','HOUSEHOLD CONSUMABLES')
        
        UNION ALL 
        
        SELECT 
        PRINT.DEAL_YEAR
        ,PRINT.REPORT_PROMO_WEEK_NUM  
        ,PRINT.DEAL_NUM
        ,PRINT.PAGE_NUM
        ,PRINT.SLOT_NUM 
        ,(PRINT.DEAL_NUM ||'-' ||PRINT.PAGE_NUM ||'-' ||PRINT.SLOT_NUM) DPS 
        ,PRINT.SLOT_SPACE_MTE_RATIO
        ,PRINT.DIVISION_NM
        ,PRINT.LOB_NM
        ,PRINT.CATEGORY_NM
        ,PRINT.FINELINE_NM 
        ,PRINT.CTR_PRODUCT_NUM
        ,PRINT.PRODUCT_ENGLISH_SHORT_DESC
        ,PRINT.SHOW_IND
        ,PRINT.REGULAR_RETAIL_PRICE_AMT
        ,PRINT.PROMO_RETAIL_PRICE_AMT
        ,PRINT.POS_FORECAST_FACTORED_QTY
        ,PRINT.POS_FORECAST_FACTORED_AMT
        ,MIN(PRINT.PROMO_RETAIL_PRICE_AMT) OVER (PARTITION BY PRINT.DEAL_YEAR,PRINT.DEAL_NUM,PRINT.PAGE_NUM,PRINT.SLOT_NUM) MIN_PROMO_PRICE
        ,MAX(PRINT.PROMO_RETAIL_PRICE_AMT) OVER (PARTITION BY PRINT.DEAL_YEAR,PRINT.DEAL_NUM,PRINT.PAGE_NUM,PRINT.SLOT_NUM) MAX_PROMO_PRICE
        ,CASE 
           WHEN MIN_PROMO_PRICE=0 THEN  ROUND(MAX_PROMO_PRICE/1,0) 
           ELSE ROUND(MAX_PROMO_PRICE/MIN_PROMO_PRICE,2) 
        END AS PRICE_MULTIPLIER
        ,CASE 
           WHEN PRICE_MULTIPLIER>=5.00 THEN 'VIOLATOR'
           ELSE 'PASS'
        END AS VIOLATOR
        FROM EDWPRDAWPRP.ADMIN_CTC.UV_PRINT_MEDIA_DIM PRINT
        LEFT JOIN EDWPRD.ADMIN_CTC.PRODUCT_CURRENT_DIM PROD ON PRINT.CTR_PRODUCT_NUM = PROD.PRODUCT_NUM 
        LEFT JOIN  (SELECT 
                 DISTINCT DEAL_NUM
                 ,DEAL_YEAR
                 ,DEAL_KIND_ENGLISH_NM
                 FROM EDWPRD.ADMIN_CTC.DEAL_CURRENT_DIM
                 WHERE DEAL_YEAR = CAST(EXTRACT(YEAR FROM CURRENT_DATE) AS VARCHAR(4))
                ) DEAL ON PRINT.DEAL_YEAR = DEAL.DEAL_YEAR AND PRINT.DEAL_NUM = DEAL.DEAL_NUM
        WHERE PRINT.SLOT_SPACE_MTE_RATIO >=0.2 AND PRINT.SHOW_IND ='N' AND PRINT.DEAL_YEAR = CAST(EXTRACT(YEAR FROM CURRENT_DATE) AS VARCHAR(4)) 
        AND PRINT.PAGE_NUM<>-1
        AND PROD.PRODUCT_TYPE_CD <> 'PPK'  
        AND DEAL.DEAL_KIND_ENGLISH_NM NOT IN ('ORDERING TOOL', 'IEP DEAL','GRAND OPENING') 
        AND PRINT.LOB_NM <> 'FOOD & DRINKS' AND PRINT.CATEGORY_NM NOT IN ('HOUSEHOLD CLEANING SOLUTIONS', 'LAUNDRY, HAND & DISH CLEANING SOLUTIONS','PET ACCESSORIES','PET FOOD','HOUSEHOLD CONSUMABLES')
        
        
        UNION ALL 
        
         SELECT 
        PRINT.DEAL_YEAR
        ,PRINT.REPORT_PROMO_WEEK_NUM  
        ,PRINT.DEAL_NUM
        ,PRINT.PAGE_NUM
        ,PRINT.SLOT_NUM 
        ,(PRINT.DEAL_NUM ||'-' ||PRINT.PAGE_NUM ||'-' ||PRINT.SLOT_NUM) DPS 
        ,PRINT.SLOT_SPACE_MTE_RATIO
        ,PRINT.DIVISION_NM
        ,PRINT.LOB_NM
        ,PRINT.CATEGORY_NM
        ,PRINT.FINELINE_NM 
        ,PRINT.CTR_PRODUCT_NUM
        ,PRINT.PRODUCT_ENGLISH_SHORT_DESC
        ,PRINT.SHOW_IND
        ,PRINT.REGULAR_RETAIL_PRICE_AMT
        ,PRINT.PROMO_RETAIL_PRICE_AMT
        ,PRINT.POS_FORECAST_FACTORED_QTY
        ,PRINT.POS_FORECAST_FACTORED_AMT
        ,MIN(PRINT.PROMO_RETAIL_PRICE_AMT) OVER (PARTITION BY PRINT.DEAL_YEAR,PRINT.DEAL_NUM,PRINT.PAGE_NUM,PRINT.SLOT_NUM) MIN_PROMO_PRICE
        ,MAX(PRINT.PROMO_RETAIL_PRICE_AMT) OVER (PARTITION BY PRINT.DEAL_YEAR,PRINT.DEAL_NUM,PRINT.PAGE_NUM,PRINT.SLOT_NUM) MAX_PROMO_PRICE
        ,CASE 
           WHEN MIN_PROMO_PRICE=0 THEN  ROUND(MAX_PROMO_PRICE/1,0) 
           ELSE ROUND(MAX_PROMO_PRICE/MIN_PROMO_PRICE,2) 
        END AS PRICE_MULTIPLIER
        ,CASE 
           WHEN PRICE_MULTIPLIER>10.00 OR MAX_PROMO_PRICE > 50.00  THEN 'VIOLATOR'
           ELSE 'PASS'
        END AS VIOLATOR
        FROM EDWPRDAWPRP.ADMIN_CTC.UV_PRINT_MEDIA_DIM PRINT
        LEFT JOIN EDWPRD.ADMIN_CTC.PRODUCT_CURRENT_DIM PROD ON PRINT.CTR_PRODUCT_NUM = PROD.PRODUCT_NUM 
        LEFT JOIN  (SELECT 
                 DISTINCT DEAL_NUM
                 ,DEAL_YEAR
                 ,DEAL_KIND_ENGLISH_NM
                 FROM EDWPRD.ADMIN_CTC.DEAL_CURRENT_DIM
                 WHERE DEAL_YEAR = CAST(EXTRACT(YEAR FROM CURRENT_DATE) AS VARCHAR(4))
                ) DEAL ON PRINT.DEAL_YEAR = DEAL.DEAL_YEAR AND PRINT.DEAL_NUM = DEAL.DEAL_NUM
        WHERE  PRINT.DEAL_YEAR = CAST(EXTRACT(YEAR FROM CURRENT_DATE) AS VARCHAR(4)) 
        AND PRINT.PAGE_NUM<>-1 
        AND DEAL.DEAL_KIND_ENGLISH_NM NOT IN ('ORDERING TOOL', 'IEP DEAL','GRAND OPENING') 
        AND PRINT.LOB_NM = 'FOOD & DRINKS' AND PRINT.CATEGORY_NM IN ('HOUSEHOLD CLEANING SOLUTIONS', 'LAUNDRY, HAND & DISH CLEANING SOLUTIONS','PET ACCESSORIES','PET FOOD','HOUSEHOLD CONSUMABLES')
        AND PROD.PRODUCT_TYPE_CD <> 'PPK'    
) 
SELECT
MAIN.*
,SUB.FLD_PSO_FILTER
,MPP.MPP_NAME

FROM MAIN

INNER JOIN (SELECT
        DISTINCT DEAL_NUM
        ,DEAL_START_DATE  
        ,DEAL_START_DATE - CURRENT_DATE AS DAY_LEFT
        ,CASE
            WHEN DAY_LEFT BETWEEN 61 AND 67 THEN 'FLD'
            WHEN DAY_LEFT BETWEEN 36 AND 42 THEN 'PSO'
            WHEN DAY_LEFT BETWEEN 20 AND 25 THEN 'PRINT'
            ELSE 'NOT_QUALIFIED' 
        END AS FLD_PSO_FILTER     
        FROM UV_PRINT_MEDIA_DIM
        WHERE DEAL_YEAR = CAST(EXTRACT(YEAR FROM CURRENT_DATE) AS VARCHAR(4))) SUB 
        ON MAIN.DEAL_NUM = SUB.DEAL_NUM 
LEFT JOIN P0016_EXT_MPP_LIST MPP ON MAIN.CATEGORY_NM = MPP.BUS_CAT
WHERE SUB.FLD_PSO_FILTER IN ('FLD','PSO','PRINT') AND MAIN.VIOLATOR = 'VIOLATOR'

)
